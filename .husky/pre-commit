#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Skip validation on release branch (CI manages version there)
if [ "$BRANCH" = "release" ]; then
  echo "✅ Release branch - skipping version format check"
  exit 0
fi

# Validate version format (must be X.Y.Z-YYYYMMDD.N for dev branches)
VERSION=$(node -p "require('./package.json').version")

if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-[0-9]{8}\.[0-9]+$'; then
  echo "❌ ERROR: Invalid version format in package.json"
  echo "   Current: $VERSION"
  echo "   Expected: X.Y.Z-YYYYMMDD.N (e.g., 1.1.1-20251126.1)"
  echo ""
  echo "   This format indicates you're working from the dev branch."
  echo "   Version is managed by CI/CD and should not be manually changed."
  exit 1
fi

echo "✅ Version format valid: $VERSION"
